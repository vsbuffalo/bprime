import sys
sys.path.extend(['../../']) # for bprime modules

if not len(config):
    raise ValueError("config file not specified on command line, use --configfile config.json")

name = config['name']
activs = config['activs']
nreps = config['fit_nreps']
archs = config['archs']

SIMDIR = "../../data/slim_sims/"

def get_outfile(name, dir=None, suffix=''):
     dir = dir if dir is not None else ''
     return os.path.join(dir, name.replace('/', '')+suffix)

def fill_suffix(name, suffix):
    return name.replace('{suffix}', suffix)


FILENAME = os.path.join(SIMDIR, "fits", f"{name}/{name}_{{n128}}n128_{{n64}}n64_{{n32}}n32_{{n8}}n8_{{nx}}nx_{{activ}}activ_fit_{{rep}}rep{{suffix}}")


npz_file = get_outfile(name, suffix='.npz')
data_file = get_outfile(name, suffix='_data.pkl')

#print(npz_file, data_file)
#sys.exit()

dnn_files = []
for arch in archs:
    for activ in activs:
        for rep in range(nreps):
            kwargs = {**arch, 'activ': activ, 'rep': rep}
            dnn_files.append(FILENAME.format(**kwargs, suffix='.pkl'))
            dnn_files.append(FILENAME.format(**kwargs, suffix='.h5'))


rule process_trees:
    input: 
    output: npz_file
    shell:
        f"""
        python ../../tools/trees2data.py --outfile {{output}} --ncores 40 \
          --features 'mu,s,L,rbp,rf,h,rep' {os.path.join(SIMDIR, name)}
        """

rule process_data:
  input: json=f"{name}.json", npz=npz_file
  output: data_file
  shell:
     """
     python ../../tools/fit_sims.py data --outfile {output} {input.json} {input.npz}
     """

rule fit_dnn:
  input: data_file
  output: model=fill_suffix(FILENAME, '.pkl'), keras=fill_suffix(FILENAME, '.h5')
  shell:
     """
     module load cuda/10.1
     python ../../tools/fit_sims.py fit --outfile {output.model} --batch-size 128 --n128 {wildcards.n128} \
      --n64 {wildcards.n64} --n32 {wildcards.n32} --n8 {wildcards.n8} --nx {wildcards.nx} \
      --activation {activ} {input} 
     """

rule data:
  input: data_file

rule train:
  input: dnn_files 

